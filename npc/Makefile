# Sanity check
ifeq ($(wildcard $(NPC_HOME)/csrc/npc-main.c),)
  $(error NPC_HOME=$(NEMU_HOME) is not a NEMU repo)
endif

# Include variables and rules generated by menuconfig
-include $(NPC_HOME)/include/config/auto.conf
-include $(NPC_HOME)/include/config/auto.conf.cmd

remove_quote = $(patsubst "%",%,$(1))

# Extract variabls from menuconfig
GUEST_ISA ?= $(call remove_quote,$(CONFIG_ISA))
ENGINE ?= $(call remove_quote,$(CONFIG_ENGINE))
NAME    = $(GUEST_ISA)-npc-$(ENGINE)

# Include all filelist.mk to merge file lists
FILELIST_MK = $(shell find -L ./csrc -name "filelist.mk")
include $(FILELIST_MK)

# Filter out directories and files in blacklist to obtain the final set of source files
DIRS-BLACKLIST-y += $(DIRS-BLACKLIST)
CSRCS-BLACKLIST-y += $(CSRCS-BLACKLIST) $(shell find -L $(DIRS-BLACKLIST-y) -name "*.c")
CSRCS-y += $(shell find -L $(DIRS-y) -name "*.c")
CSRCS = $(filter-out $(CSRCS-BLACKLIST-y),$(CSRCS-y))
VSRCS = $(shell find $(abspath ./vsrc) -name "*.v")

# Extract compiler and options from menuconfig
ifneq ($(CONFIG_VERILOG_COMPILER),)
VERILATOR = $(call remove_quote,$(CONFIG_VERILOG_COMPILER))
endif 

ifneq ($(CONFIG_DIFFTEST_REF_NAME),"none")
ARGS_DIFF = -d $(call remove_quote,$(CONFIG_DIFFTEST_REF_PATH))
endif

INC_PATH ?=
VERILATOR_CFLAGS += -MMD --build -cc --exe --trace\
				-O3 --x-assign fast --x-initial fast --noassert\
				-DUSE_RVE=$(CONFIG_RVE)\

# Include rules for menuconfig
include $(NPC_HOME)/scripts/config.mk

ifdef CONFIG_TARGET_AM
include $(AM_HOME)/Makefile
LINKAGE += $(ARCHIVES)
else
# Include rules to build NPC
include $(NPC_HOME)/scripts/native.mk
endif

